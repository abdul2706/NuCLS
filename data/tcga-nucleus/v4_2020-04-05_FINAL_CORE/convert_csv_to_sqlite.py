from sqlalchemy import create_engine
import pandas as pd
from tqdm import tqdm

# all_fovs = pd.read_csv('CORE_SET/QC/csv/ALL_FOV_LOCATIONS.csv', index_col=0)
# all_fovs['slide_name'] = all_fovs['fovname'].apply(lambda x: x.split('_')[0])
# print(all_fovs.head(10))

sql_engine = create_engine('sqlite:///v4_2020-04-05_FINAL_CORE.sqlite', echo=False)
dbcon = sql_engine.connect()

###########################
# CREATE table `fov_meta` #
###########################
# query = """CREATE TABLE IF NOT EXISTS fov_meta (
#                     'fov_id' INT NOT NULL, 
#                     'fovname' VARCHAR(250), 
#                     'slide_name' VARCHAR(100), 
#                     'xmin' INT, 
#                     'ymin' INT, 
#                     'xmax' INT, 
#                     'ymax' INT, 
#                     PRIMARY KEY (fov_id)
#                 )"""
# print('[query]', query)
# dbcon.execute(query)

######################################
# CREATE table `annotation_elements` #
######################################
# query = """CREATE TABLE IF NOT EXISTS annotation_elements (
#                     'ann_id' INT NOT NULL, 
#                     'fov_id' INT, 
#                     'group' VARCHAR(25), 
#                     'type' VARCHAR(25), 
#                     'xmin' INT, 
#                     'ymin' INT, 
#                     'xmax' INT, 
#                     'ymax' INT, 
#                     PRIMARY KEY (ann_id)
#                 )"""
# print('[query]', query)
# dbcon.execute(query)

################################
# INSERT INTO table `fov_meta` #
################################
# for idx, row in tqdm(all_fovs.iterrows(), total=len(all_fovs)):
#     query = f"""INSERT INTO fov_meta VALUES 
#                     ('{idx}', 
#                      '{row['fovname']}', 
#                      '{row['slide_name']}', 
#                      '{row['xmin']}', 
#                      '{row['ymin']}', 
#                      '{row['xmax']}', 
#                      '{row['ymax']}')
#                     """
#     # print(f'[{idx}][query]', query)
#     dbcon.execute(query)

# confirm INSERT using SELECT
# fov_meta = pd.read_sql_query(f"""SELECT * FROM fov_meta""", con=dbcon)
# print('[fov_meta]\n', fov_meta)

###########################################
# INSERT INTO table `annotation_elements` #
###########################################
# ann_id = 0
# for fov_id, row_fov in tqdm(all_fovs.iterrows(), total=len(all_fovs)):
#     df_csv_file = pd.read_csv(f"CORE_SET/QC/csv/{row_fov['fovname']}.csv")
#     for idx, row in df_csv_file.iterrows():
#         query = f"""INSERT INTO annotation_elements VALUES (
#                         '{ann_id}', 
#                         '{fov_id}', 
#                         '{row['group']}', 
#                         '{row['type']}', 
#                         '{row['xmin']}', 
#                         '{row['ymin']}', 
#                         '{row['xmax']}', 
#                         '{row['ymax']}'
#                     )"""
#         dbcon.execute(query)
#         ann_id += 1

# confirm INSERT using SELECT
annotation_elements = pd.read_sql_query(f"""SELECT * FROM "annotation_elements";""", con=dbcon)
print('[annotation_elements]\n', annotation_elements)

fovstr = '"26","30","25","28","29","23","24","27","32","31","33","34","36","35","45","50","46","49","54","57","47","48","52","40","38","53","51","37","42","39","41","43","55","44","56","63","62","61","58","60","59","70","69","72","67","71","66","68","64","65","86","76","77","88","75","84","80","78","83","73","82","81","74","79","85","87","89","91","90","108","116","113","104","122","105","107","120","114","121","92","99","110","112","94","109","95","97","119","100","98","106","117","93","111","96","115","118","101","102","103","123","140","124","129","144","149","139","151","138","134","141","127","136","135","146","132","153","126","142","130","150","137","125","131","143","128","152","147","133","145","148","162","160","161","159","158","155","154","157","156","185","163","182","172","173","165","164","188","184","166","167","170","168","189","192","193","180","187","190","181","179","191","169","186","171","194","178","175","183","176","174","177","202","213","199","198","214","209","205","197","201","206","210","200","217","207","203","216","211","215","204","196","195","208","212","227","225","226","223","224","222","219","218","220","221","261","253","249","230","254","255","246","237","257","238","232","251","241","234","235","252","259","236","260","256","239","245","240","250","242","258","243","244","247","248","228","229","231","233","283","279","274","290","273","294","286","284","266","271","291","292","269","267","272","268","262","270","263","285","265","293","288","281","282","275","280","278","289","276","264","287","277","298","302","303","295","297","301","296","300","299","326","325","308","316","328","311","329","317","323","306","318","330","320","321","312","310","331","322","315","319","304","314","324","307","335","313","333","309","327","305","336","343","351","344","348","360","337","345","339","342","338","356","346","341","349","358","359","350","340","353","357","347","354","355","352","375","376","382","377","381","378","379","367","368","380","366","364","372","371","373","363","362","374","370","361","365","369","389","387","383","390","385","384","388","386","420","415","392","418","394","410","408","419","414","417","405","399","398","407","393","403","400","413","401","396","402","411","409","412","406","395","404","397","391","416","424","422","423","426","421","425","431","430","429","427","428","442","446","447","459","455","480","433","472","462","458","443","435","473","453","436","454","457","434","444","440","450","474","471","481","439","482","478","445","449","460","437","461","467","448","438","477","475","451","432","452","476","479","463","465","441","456","468","464","466","469","470","487","492","488","493","484","485","486","489","490","483","491","494","521","518","513","514","520","516","515","519","517","526","525","522","523","524","550","551","568","560","570","573","552","557","559","569","527","574","558","553","555","556","561","572","563","564","565","562","554","571","566","567","549","540","542","538","529","531","537","543","548","536","532","541","547","534","544","545","530","533","546","539","528","535","575","577","576","594","616","596","597","595","600","605","614","585","609","586","578","581","618","579","580","592","612","588","606","602","603","617","583","607","613","599","584","598","590","604","593","611","610","601","615","608","582","587","589","591","619","620","623","621","622","626","624","625","627","628","637","636","629","631","634","630","633","632","635","638","640","641","639","642","643","644","645","646","647","649","650","648","660","659","653","651","661","654","662","655","658","652","656","657","663","667","666","664","665","668","673","671","669","670","672","675","676","678","679","674","677","680","702","706","693","694","703","692","696","708","697","685","695","709","699","688","704","701","710","712","698","714","715","711","713","684","690","682","683","681","689","686","705","687","700","691","707","717","716","721","718","720","719","722","724","723","729","728","727","730","726","725","742","747","746","741","734","739","732","731","735","737","738","733","740","745","743","736","748","744","749","751","750","755","756","753","752","754","758","757","763","765","764","759","760","761","762","879","877","875","878","874","876","882","880","881","885","883","884","886","892","894","889","893","888","887","891","890","898","896","897","899","895","900","901","902","918","908","920","917","906","903","904","913","907","929","927","931","932","940","933","930","915","905","914","939","942","936","910","934","919","909","921","938","935","916","941","943","937","928","912","926","922","925","911","924","923","944","946","945","953","951","948","952","949","950","947","959","956","971","964","963","965","967","970","958","968","955","954","972","962","957","960","966","961","969","985","988","1003","1001","982","980","989","1015","1013","974","984","1012","986","991","1005","1002","981","1006","1014","987","1007","1009","1010","1004","979","998","1000","999","1008","995","975","994","992","977","990","997","983","978","1011","993","996","973","976","1022","1021","1017","1023","1016","1018","1020","1019","1036","1024","1027","1025","1034","1035","1026","1028","1030","1031","1029","1032","1033","1037","1042","1040","1039","1038","1041","1050","1048","1045","1046","1043","1047","1049","1044","1053","1054","1051","1052","1055","1057","1056","1060","1058","1059","1069","1063","1071","1064","1061","1062","1065","1068","1066","1070","1075","1074","1072","1067","1073","1079","1078","1080","1077","1081","1082","1076","1085","1084","1083","1086","1094","1088","1092","1090","1091","1087","1089","1097","1095","1096","1093","1113","1114","1116","1104","1118","1109","1110","1115","1100","1103","1108","1111","1101","1112","1102","1105","1098","1106","1099","1107","1117","1119","1121","1120","1133","1136","1134","1137","1135","1122","1128","1130","1123","1129","1124","1138","1131","1126","1125","1127","1132","1142","1143","1152","1144","1157","1145","1140","1149","1139","1155","1156","1148","1153","1151","1150","1147","1141","1146","1154","1166","1161","1160","1158","1169","1164","1163","1159","1162","1165","1167","1168","1170","1180","1175","1171","1181","1182","1172","1176","1177","1173","1183","1174","1178","1179","1185","1184","1194","1186","1198","1189","1197","1188","1195","1187","1192","1191","1190","1202","1201","1193","1199","1200","1196","1226","1207","1227","1219","1223","1216","1235","1228","1214","1240","1234","1236","1247","1224","1220","1233","1249","1225","1248","1208","1205","1206","1232","1209","1221","1213","1241","1229","1237","1211","1230","1244","1242","1215","1203","1212","1204","1245","1238","1231","1217","1243","1222","1210","1218","1246","1239","1251","1253","1252","1254","1250","1257","1258","1261","1255","1263","1260","1256","1262","1264","1259","1265","1268","1270","1267","1266","1269","1279","1275","1280","1281","1276","1277","1274","1278","1272","1273","1271","1283","1282","1284","1286","1285","1290","1291","1289","1287","1288","1292","1293","1294","1296","1295","1297","1298","1308","1300","1299","1305","1304","1306","1301","1327","1332","1334","1324","1330","1333","1313","1323","1312","1314","1309","1326","1331","1322","1315","1325","1310","1328","1321","1329","1319","1302","1317","1303","1307","1318","1320","1311","1316","1335","1352","1350","1347","1345","1338","1342","1343","1336","1340","1346","1344","1341","1351","1337","1339","1348","1349","1354","1357","1355","1353","1358","1356","1369","1370","1371","1359","1367","1368","1360","1361","1363","1364","1362","1365","1366","1373","1372","1425","1388","1401","1387","1411","1384","1389","1394","1393","1386","1402","1420","1426","1399","1383","1404","1413","1385","1400","1391","1408","1414","1377","1382","1409","1381","1376","1424","1380","1421","1396","1378","1419","1392","1422","1405","1406","1395","1397","1374","1416","1412","1390","1403","1429","1427","1375","1415","1423","1398","1418","1428","1417","1379","1407","1410","1433","1431","1430","1432","1434","1442","1437","1438","1441","1435","1439","1436","1440","1443","1472","1473","1479","1474","1471","1480","1476","1481","1463","1465","1478","1477","1482","1468","1464","1461","1458","1475","1457","1454","1460","1449","1459","1455","1469","1451","1453","1448","1447","1450","1462","1470","1446","1452","1445","1456","1483","1466","1444","1467","1501","1493","1491","1504","1505","1486","1498","1490","1488","1484","1489","1487","1492","1485","1499","1494","1500","1497","1496","1495","1503","1502","1543","1541","1544","1515","1528","1513","1508","1530","1510","1516","1531","1518","1514","1536","1520","1547","1512","1525","1542","1532","1524","1509","1511","1545","1529","1546","1540","1534","1539","1526","1537","1535","1527","1538","1519","1507","1522","1506","1517","1533","1521","1523","1551","1549","1552","1550","1548","1556","1555","1559","1554","1560","1553","1558","1557","1564","1562","1566","1561","1568","1565","1563","1567","1574","1572","1571","1570","1569","1573","1577","1576","1575","1578","1588","1579","1587","1586","1582","1584","1583","1581","1585","1580","1716","1707","1711","1709","1721","1713","1724","1719","1712","1720","1710","1723","1722","1714","1717","1718","1725","1715","1705","1703","1726","1704","1706","1708","1745","1742","1737","1729","1744","1730","1735","1739","1741","1743","1731","1734","1732","1733","1740","1727","1738","1728","1736"'
annotation_elements = pd.read_sql_query(f"""SELECT "fov_id", "xmin", "ymin", "xmax", "ymax"
                                            FROM "annotation_elements"
                                            WHERE "fov_id" IN ({fovstr})
                                            AND "group" NOT LIKE "fov%";
                                        """, con=dbcon)
print('[annotation_elements]\n', annotation_elements)

# sql_connection.execute("CREATE TABLE fov_meta ('fovname', 'fov_id', 'slide_name');")
# sql_connection.execute("INSERT INTO fov_meta VALUES ('fovname1', '1', 'slide_name1');")
